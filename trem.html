<html lang="zh-Hant">

<head>
    <title id="title"></title>
    <meta charset="utf-8" />
    <meta content="TREM 即時強震觀測網" property="og:title" />
    <meta content="Taiwan Real-time Earthquake Monitoring ( 臺灣即時地震監測 )" property="og:description" />
    <meta content="https://exptechtw.github.io/" property="og:url" />
    <meta content="https://raw.githubusercontent.com/ExpTechTW/ExpTechTW.github.io/master/image/main/ExpTech.jpg"
        property="og:image" />
</head>

<body>
    <div>
        <div>
            <div class="title">TREM 即時強震觀測網</div>
            <div class="subtitle">地震時可於畫面中看見各地即時震度 (註: 即時意旨1秒前)</div>
            <div class="warn" style="color: lightcoral;">僅供參考 最終結果依 <b>中央氣象局(CWB)</b> 公布之內容為準</div>
        </div>
        <div>
            <img src="https://exptech.com.tw/api/v1/file/resource/taiwan.png" class="img">
            <img src="https://exptech.com.tw/api/v1/file/resource/int.png" class="img">
            <img src="https://exptech.com.tw/api/v1/trem/rts-image?v=0" id="img" class="img">
        </div>
        <div id="eew-info" class="info">
            <div>
                <a id="eew-time"></a>
                <a id="eew-number"></a>
                <a id="eew-loc"></a>
            </div>
            <div>
                <a id="eew-scale"></a>
                <a id="eew-depth"></a>
                <a id="eew-max"></a>
            </div>
        </div>
        <div class="control">
            <a id="time" class="subtitle">----/--/-- --:--:--</a>
            <div>
                <input id="control" type="range" min="0" max="86400" step="1" value="86400" style="width: 500px;">
            </div>
            <div>
                <button id="last" disabled>最新</button>
                <button id="switch">暫停</button>
                <button id="audio" style="color: green;">開啟音效</button>
            </div>
            <a style="color: lightskyblue;" href="https://exptech.com.tw/api/v1/file/trem-infos.html">TREM Earthquake
                History</a>
        </div>
        <audio id="audio_warn">
            <source src="https://exptech.com.tw/api/v1/file/resource/warn.mp3" type="audio/mpeg">
        </audio>
        <audio id="audio_alert">
            <source src="https://exptech.com.tw/api/v1/file/resource/alert.mp3" type="audio/mpeg">
        </audio>
    </div>

    <style>
        @import url(https://fonts.googleapis.com/earlyaccess/cwtexyen.css);

        div {
            display: block;
        }

        button {
            font-size: 16px;
            padding: 3px;
            border-radius: 5px;
            color: white;
            background-color: #333439;
            margin: 5px;
            padding: 2px;
        }

        html,
        body {
            font-family: "cwTeXYen", sans-serif;
            background-color: #1F2026;
            color: white;
        }

        .title {
            font-weight: 900;
            font-size: 24px;
        }

        .subtitle {
            font-weight: 200;
            font-size: 16px;
        }

        .img {
            position: absolute;
            height: 518;
            width: 605;
            padding: 3px;
            left: 10px;
            top: 110px;
            border: 2px solid white;
            border-radius: 5px;
        }

        .info {
            position: absolute;
            left: 10px;
            top: 645px;
            border: 2px solid white;
            border-radius: 5px;
            padding: 3px;
            font-size: 20px;
            height: 50px;
            width: 450px;
        }

        .control {
            position: absolute;
            left: 10px;
            top: 715px;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0/axios.min.js"></script>
    <script>
        let time = 0;
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        time = Number(params.time);
        if (isNaN(time)) time = 0;
        const audio_warn = document.getElementById("audio_warn");
        const audio_alert = document.getElementById("audio_alert");
        const audio = document.getElementById("audio");

        const image = document.getElementById("img");
        const last = document.getElementById("last");
        const s = document.getElementById("switch");
        const control = document.getElementById("control");
        const t = document.getElementById("time");
        if (time) t.style.color = "yellow";

        const eew_info = document.getElementById("eew-info");
        const eew_time = document.getElementById("eew-time");
        const eew_number = document.getElementById("eew-number");
        const eew_loc = document.getElementById("eew-loc");
        const eew_scale = document.getElementById("eew-scale");
        const eew_depth = document.getElementById("eew-depth");
        const eew_max = document.getElementById("eew-max");

        const Intensity = [
            { value: 0, text: "０級", label: "0", color: "#A6ADAD" },
            { value: 1, text: "１級", label: "1", color: "#6B7878" },
            { value: 2, text: "２級", label: "2", color: "#1E6EE6" },
            { value: 3, text: "３級", label: "3", color: "#32B464" },
            { value: 4, text: "４級", label: "4", color: "#FFE05D" },
            { value: 5, text: "５弱", label: "5⁻", color: "#FFAA13" },
            { value: 6, text: "５強", label: "5⁺", color: "#EF700F" },
            { value: 7, text: "６弱", label: "6⁻", color: "#E60000" },
            { value: 8, text: "６強", label: "6⁺", color: "#A00000" },
            { value: 9, text: "７級", label: "7", color: "#5D0090" },
        ];

        const time_string = (time) => {
            const now = new Date(time);
            let Now = now.getFullYear().toString();
            Now += "/";
            if ((now.getMonth() + 1) < 10) Now += "0" + (now.getMonth() + 1).toString();
            else Now += (now.getMonth() + 1).toString();
            Now += "/";
            if (now.getDate() < 10) Now += "0" + now.getDate().toString();
            else Now += now.getDate().toString();
            Now += " ";
            if (now.getHours() < 10) Now += "0" + now.getHours().toString();
            else Now += now.getHours().toString();
            Now += ":";
            if (now.getMinutes() < 10) Now += "0" + now.getMinutes().toString();
            else Now += now.getMinutes().toString();
            Now += ":";
            if (now.getSeconds() < 10) Now += "0" + now.getSeconds().toString();
            else Now += now.getSeconds().toString();
            return Now;
        }

        let state = true;
        let lock = false;
        let audio_state = false;
        let info_data = {};
        let eew_alert = false;
        let last_audio_time = 0;

        audio.onclick = () => {
            audio_state = !audio_state;
            if (audio_state) {
                audio.style.color = "red";
                audio.textContent = "關閉音效";
                audio_warn.play();
            } else {
                audio.style.color = "green";
                audio.textContent = "開啟音效";
            }
        }
        last.onclick = () => {
            last.disabled = true;
            time = 0;
            t.style.color = "white";
        }
        s.onclick = () => {
            state = !state;
            if (state) {
                t.style.color = "yellow";
                last.disabled = false;
                s.textContent = "暫停";
            } else {
                t.style.color = "red";
                last.disabled = true;
                if (!time) time = Date.now();
                s.textContent = "播放";
            }
        }
        control.oninput = () => {
            if (control.value == 86400) {
                t.style.color = "white";
                last.disabled = true;
            } else {
                last.disabled = false;
                t.style.color = "yellow";
            }
            time = Date.now() - (86400 - control.value) * 1000;
            t.textContent = `${time_string(time)} (重播)`;
        }
        control.onmousedown = () => { lock = true; }
        control.onmouseup = () => { lock = false; }

        const updateImage = () => { image.src = `${image.src.split("?")[0]}?v=${Date.now()}${(time) ? `&time=${time}` : ""}`; }
        const updateInfo = () => {
            axios.get(`https://exptech.com.tw/api/v1/earthquake/info?time=${(!time) ? 0 : Math.floor(time / 1000)}`)
                .then(res => {
                    info_data = res.data;
                    console.log(res.data)
                    console.log(time_string(res.data.time * 1000))
                })
                .catch(err => console.error(err));
        }
        setInterval(() => {
            if (!lock) {
                control.value = 86400 - ((!time) ? 0 : (Date.now() - time) / 1000);
                t.textContent = `${time_string((!time) ? Date.now() : time)} (${(t.style.color == "yellow") ? "重播" : (t.style.color == "red") ? "暫停" : "即時"})`;
            }
            if (!state) return;
            if (time) time += 1000;
            updateImage();
            updateInfo();
            if (info_data.rts) {
                if (audio_state && Date.now() - last_audio_time > 1500) {
                    last_audio_time = Date.now();
                    audio_warn.play();
                }
            }
            if (info_data.eew) {
                if (!eew_alert) {
                    eew_alert = true;
                    if (audio_state) audio_alert.play();
                }
                eew_time.textContent = time_string(info_data.eew.time);
                eew_number.textContent = `第${info_data.eew.number}報`;
                eew_loc.textContent = info_data.eew.location;
                eew_scale.textContent = `M${info_data.eew.scale}`;
                eew_depth.textContent = `深度${info_data.eew.depth}km`;
                eew_max.textContent = `最大預估震度 ${(info_data.eew.max == undefined) ? "未知" : Intensity[info_data.eew.max].text}`;
                if (info_data.eew.max != undefined) {
                    eew_info.style.color = "yellow";
                    if (info_data.eew.max > 4) eew_info.style.color = "red";
                }
            } else {
                eew_time.textContent = "";
                eew_number.textContent = "";
                eew_loc.textContent = "";
                eew_scale.textContent = "";
                eew_depth.textContent = "";
                eew_max.textContent = "";
                eew_alert = false;
            }
        }, 1000);
    </script>
</body>

</html>