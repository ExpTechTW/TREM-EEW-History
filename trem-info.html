<html lang="zh-Hant">

<head>
    <title id="title">TREM Earthquake History</title>
    <meta charset="utf-8" />
    <meta content="TREM Earthquake History" property="og:title" />
    <meta content="TREM Earthquake History | TREM 地震預警紀錄" property="og:description" />
    <meta content="https://exptechtw.github.io/" property="og:url" />
    <meta content="https://raw.githubusercontent.com/ExpTechTW/ExpTechTW.github.io/master/image/main/ExpTech.jpg"
        property="og:image" />
</head>

<body style="background-color: #333439;user-select: none;">
    <div>
        <div style="padding: 10px;">
            <a id="back" style="color: white;text-decoration: none;">←
                返回列表</a>
            <a id="mode" style="color: white;text-decoration: none;display: none;cursor: pointer;"
                onclick="switch_mode(null)">←
                上一頁</a>
        </div>
        <div id="ID" style="color: white;font-size: 40px;font-weight: 900;"></div>
        <div style="display: grid;">
            <a id="old" style="color: lightskyblue;">舊版頁面</a>
            <a id="report-cwb" style="color: lightskyblue;display: none;">地震報告(CWB)</a>
        </div>
        <div style="color: lightcoral;font-size: 16px;padding: 5px;">⚠️ 此頁面所有資料均來自 TREM 結果請依 <b>中央氣象局</b> 發布之內容為準
        </div>
        <table id="trem">
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>測站位置</th>
                    <th>X</th>
                    <th>Y</th>
                    <th>Z</th>
                    <th>PGA(gal)<br>[理論(gal)]</th>
                    <th>PGV(kine)</th>
                    <th>震度</th>
                    <th>日期</th>
                    <th>起始</th>
                    <th>結束</th>
                    <th>P(自動)</th>
                    <th>S(自動)</th>
                    <th>P(理論)</th>
                    <th>S(理論)</th>
                    <th>震央距(km)</th>
                </tr>
            </thead>
            <tbody id="trem-table"></tbody>
        </table>
        <table id="eew" style="display: none;">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>類型</th>
                    <th>日期</th>
                    <th>發布時間</th>
                    <th>發震時間</th>
                    <th>震央位置</th>
                    <th>北緯</th>
                    <th>東經</th>
                    <th>深度</th>
                    <th>規模</th>
                    <th>最大預估震度</th>
                    <th>警報</th>
                </tr>
            </thead>
            <tbody id="eew-table"></tbody>
        </table>
        <table id="raw" style="display: none;">
            <thead>
                <tr>
                    <th>UUID</th>
                    <th>三軸合成</th>
                    <th>垂直向(震幅)</th>
                    <th>日期</th>
                    <th>P(自動)</th>
                    <th>S(自動)</th>
                </tr>
            </thead>
            <tbody id="raw-table"></tbody>
        </table>
    </div>

    <style>
        body {
            font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        table {
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            font-family: sans-serif;
            min-width: 400px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        table>thead>tr {
            background-color: hsl(300deg 100% 30%);
            text-align: left;
        }

        table th,
        table td {
            color: #fff;
            padding: 12px 15px;
            text-align: center;
        }

        table>tbody>tr>td::after {
            display: block;
            content: attr(data-text);
            font-weight: bold;
            height: 0;
            overflow: hidden;
            visibility: hidden;
            pointer-events: none;
        }

        table>tbody>tr {
            background-color: hsl(300deg 100% 30% / 12%);
        }

        table>tbody>tr:nth-of-type(even) {
            background-color: hsl(300deg 100% 60% / 12%);
        }

        table>tbody>tr:last-of-type {
            border-bottom: 2px solid hsl(300deg 100% 30%);
        }

        table>tbody>tr:hover {
            font-weight: bold;
            color: hsl(300deg 100% 30%);
        }

        .intensity_1 {
            color: white;
            background-color: #6B7878;
        }

        .intensity_2 {
            color: white;
            background-color: #1E6EE6;
        }

        .intensity_3 {
            color: white;
            background-color: #32B464;
        }

        .intensity_4 {
            color: black;
            background-color: #FFE05D;
        }

        .intensity_5 {
            color: black;
            background-color: #FFAA13;
        }

        .intensity_6 {
            color: black;
            background-color: #EF700F;
        }

        .intensity_7 {
            color: white;
            background-color: #E60000;
        }

        .intensity_8 {
            color: white;
            background-color: #A00000;
        }

        .intensity_9 {
            color: white;
            background-color: #5D0090;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0/axios.min.js"></script>
    <script>
        const urlSearchParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlSearchParams.entries());
        if (!params.id) window.location.href = 'https://exptech.com.tw/api/v1/file/trem-infos.html';
        document.getElementById("old").href = `https://exptech.com.tw/api/v1/file/trem-report.html?id=${params.id}`;
        const title = document.getElementById("ID");
        const back = document.getElementById("back");
        const mode = document.getElementById("mode");
        const trem = document.getElementById("trem");
        const eew = document.getElementById("eew");
        const raw = document.getElementById("raw");
        const eew_table = document.getElementById("eew-table");
        const trem_table = document.getElementById("trem-table");

        back.href = `https://exptech.com.tw/api/v1/file/trem-infos.html?key=${params.key}`;

        const timestamp = (ts, date = false, re = null) => {
            const t = new Date(ts);
            if (date) {
                return [
                    `${t.getFullYear()}/`,
                    `${t.getMonth() + 1}/`.padStart(3, "0"),
                    `${t.getDate()}`.padStart(2, "0")
                ].join("");
            } else {
                return [
                    re && new Date(re).getDate() > t.getDate() ? "（隔日）" : "",
                    `${t.getHours()}:`.padStart(3, "0"),
                    `${t.getMinutes() + 1}:`.padStart(3, "0"),
                    `${t.getSeconds()}.`.padStart(3, "0"),
                    `${t.getMilliseconds()}`.padStart(3, "0")
                ].join("");
            }
        }

        let cache = {};
        load();

        function load() {
            axios.get("https://exptech.com.tw/api/v1/file/resource/station.json")
                .then((station_data) => {
                    station_data = station_data.data;
                    axios.get(`https://exptech.com.tw/api/v1/earthquake/trem-info/${params.id}?key=${params.key}`)
                        .then((res) => {
                            const data = res.data;
                            cache = data
                            title.textContent = `${params.id}${(cache.error) ? " (誤報)" : ""}`;

                            if (data.eq.no && data.eq.no != 111000) {
                                const report_cwb = document.getElementById("report-cwb");
                                report_cwb.style.display = ""
                                const originTime = new Date(data.eq.time);
                                const cwb_code = "EQ"
                                    + data.eq.no
                                    + "-"
                                    + (originTime.getMonth() + 1 < 10 ? "0" : "") + (originTime.getMonth() + 1)
                                    + (originTime.getDate() < 10 ? "0" : "") + originTime.getDate()
                                    + "-"
                                    + (originTime.getHours() < 10 ? "0" : "") + originTime.getHours()
                                    + (originTime.getMinutes() < 10 ? "0" : "") + originTime.getMinutes()
                                    + (originTime.getSeconds() < 10 ? "0" : "") + originTime.getSeconds();
                                report_cwb.href = `https://www.cwb.gov.tw/V8/C/E/EQ/${cwb_code}.html`;
                            }

                            const frag_1 = new DocumentFragment();

                            for (let i = 0; i < data.station.length; i++) {
                                const box = document.createElement("tr");
                                const ID = document.createElement("td");
                                const uuid = data.station[i].uuid;
                                ID.innerHTML = `<a style="color: lightskyblue;font-size: 0.2em;" href="https://exptech.com.tw/api/v1/file/Download/${data.station[i].image}-waveform.png">${uuid}</a>`;
                                ID.setAttribute("data-text", ID.textContent);

                                const loc = document.createElement("td");
                                loc.innerHTML = data.station[i].name.replace(" ", "<br>");
                                loc.setAttribute("data-text", loc.textContent);

                                const x = document.createElement("td");
                                x.textContent = data.station[i].x;
                                x.setAttribute("data-text", x.textContent);

                                const y = document.createElement("td");
                                y.textContent = data.station[i].y;
                                y.setAttribute("data-text", y.textContent);

                                const z = document.createElement("td");
                                z.textContent = data.station[i].z;
                                z.setAttribute("data-text", z.textContent);

                                const pga = document.createElement("td");

                                const pgv = document.createElement("td");
                                pgv.textContent = data.station[i].pgv;
                                pgv.setAttribute("data-text", pgv.textContent);

                                const intensity = document.createElement("td");
                                intensity.textContent = intensity_int_to_string(data.station[i].intensity);
                                intensity.className = `intensity_${data.station[i].intensity}`;
                                intensity.setAttribute("data-text", intensity.textContent);

                                const time_start = convertDate(data.station[i].start.replaceAll("/", "-"));

                                const date = document.createElement("td");
                                date.textContent = timestamp(time_start, true);
                                date.setAttribute("data-text", date.textContent);

                                const start = document.createElement("td");
                                start.textContent = timestamp(time_start).split(".")[0];
                                start.setAttribute("data-text", start.textContent);

                                const end = document.createElement("td");
                                end.textContent = timestamp(data.station[i].end).split(".")[0];
                                end.setAttribute("data-text", end.textContent);

                                const p = document.createElement("td");
                                const s = document.createElement("td");
                                if (data.trem.raw) {
                                    const num = data.trem.raw.length - 1;
                                    if (data.trem.raw[num].time[uuid]) {
                                        p.textContent = (data.trem.raw[num].time[uuid] == data.trem.raw[num].s_time[uuid]) ? "" : timestamp(data.trem.raw[num].time[uuid]);
                                        p.setAttribute("data-text", p.textContent);

                                        s.textContent = timestamp(data.trem.raw[num].s_time[uuid]);
                                        s.setAttribute("data-text", s.textContent);
                                    }
                                }

                                const dist = document.createElement("td");
                                const theory_p = document.createElement("td");
                                const theory_s = document.createElement("td");
                                let theory_pga_text = "";

                                if (station_data[uuid] && data.eq.depth) {
                                    const theory_dist_surface = Math.sqrt(pow((data.eq.lat - station_data[uuid].Lat) * 111) + pow((data.eq.lon - station_data[data.station[i].uuid].Long) * 101));
                                    const theory_dist = Math.sqrt(pow(theory_dist_surface) + pow(data.eq.depth));

                                    theory_p.textContent = timestamp((theory_dist / 6.5) * 1000 + data.eq.time);
                                    theory_p.setAttribute("data-text", theory_p.textContent);
                                    theory_s.textContent = timestamp((theory_dist / 3.5) * 1000 + data.eq.time);
                                    theory_s.setAttribute("data-text", theory_s.textContent);

                                    const dist_surface = Math.sqrt(pow((data.eq.lat - station_data[uuid].Lat) * 111) + pow((data.eq.lon - station_data[data.station[i].uuid].Long) * 101));
                                    dist.textContent = (data.eq.lat && data.eq.lon) ? dist_surface.toFixed(2) : "";
                                    dist.setAttribute("data-text", dist.textContent);

                                    theory_pga_text = `<br>[${(1.657 * Math.pow(Math.E, (1.533 * data.eq.scale)) * Math.pow(Math.sqrt(pow(dist_surface) + pow(data.eq.depth)), -1.607)).toFixed(2)}]`;
                                }
                                pga.innerHTML = `${data.station[i].pga}${theory_pga_text}`;
                                pga.setAttribute("data-text", pga.textContent);

                                box.appendChild(ID);
                                box.appendChild(loc);
                                box.appendChild(x);
                                box.appendChild(y);
                                box.appendChild(z);
                                box.appendChild(pga);
                                box.appendChild(pgv);
                                box.appendChild(intensity);
                                box.appendChild(date);
                                box.appendChild(start);
                                box.appendChild(end);
                                box.appendChild(p);
                                box.appendChild(s);
                                box.appendChild(theory_p);
                                box.appendChild(theory_s);
                                box.appendChild(dist);
                                frag_1.appendChild(box);
                            }

                            trem_table.replaceChildren(frag_1);

                            if (data.trem.eew.length) {
                                eew.style.display = "";
                                const frag_2 = new DocumentFragment();

                                let Alert = false;
                                for (let i = 0; i < data.trem.eew.length; i++) {
                                    const box = document.createElement("tr");
                                    const no = document.createElement("td");
                                    no.innerHTML = `<a style="${(data.trem.raw && i < data.trem.eew.length - 1) ? "color: lightskyblue;text-decoration:underline;cursor: pointer;" : "color: white;"}" onclick="switch_mode(${i + 1})">${((i < data.trem.eew.length - 1) ? "" : "#") + (i + 1)}</a>`;
                                    no.setAttribute("data-text", no.textContent);

                                    const date = document.createElement("td");
                                    date.textContent = timestamp(data.trem.eew[i].timestamp, true);
                                    date.setAttribute("data-text", date.textContent);

                                    const time_release = document.createElement("td");
                                    time_release.textContent = timestamp(data.trem.eew[i].timestamp);
                                    time_release.setAttribute("data-text", time_release.textContent);

                                    const type = document.createElement("td");
                                    type.textContent = (data.trem.eew[i].model == "eew") ? "EEW" : "NSSPE";
                                    type.style.backgroundColor = (data.trem.eew[i].model == "eew") ? "darkslateblue" : "darkgrey";
                                    type.setAttribute("data-text", type.textContent);

                                    const time = document.createElement("td");
                                    time.textContent = (data.trem.eew[i].cancel) ? "取消" : timestamp(data.trem.eew[i].time);
                                    if (data.trem.eew[i].cancel) time.colSpan = 8;
                                    time.setAttribute("data-text", time.textContent);

                                    const loc = document.createElement("td");
                                    loc.textContent = data.trem.eew[i].location;
                                    loc.setAttribute("data-text", loc.textContent);
                                    if (data.trem.eew[i].location.includes("海")) loc.style.backgroundColor = "darkblue";
                                    else loc.style.backgroundColor = "darkgreen";

                                    const lat = document.createElement("td");
                                    lat.textContent = data.trem.eew[i].lat;
                                    lat.setAttribute("data-text", lat.textContent);

                                    const lon = document.createElement("td");
                                    lon.textContent = data.trem.eew[i].lon;
                                    lon.setAttribute("data-text", lon.textContent);

                                    const depth = document.createElement("td");
                                    depth.textContent = `${data.trem.eew[i].depth} ㎞`;
                                    depth.setAttribute("data-text", depth.textContent);

                                    const scale = document.createElement("td");
                                    scale.textContent = `M ${data.trem.eew[i].scale.toFixed(1)}`;
                                    scale.setAttribute("data-text", scale.textContent);

                                    const max = document.createElement("td");
                                    max.textContent = intensity_int_to_string(data.trem.eew[i].max);
                                    max.className = `intensity_${data.trem.eew[i].max}`;
                                    max.setAttribute("data-text", max.textContent);

                                    if (!Alert && data.trem.eew[i].max > 4) Alert = true
                                    const alert = document.createElement("td");
                                    alert.textContent = (data.trem.eew[i].alert || Alert) ? "是" : "否";
                                    alert.setAttribute("data-text", alert.textContent);
                                    if (data.trem.eew[i].alert || Alert) alert.style.backgroundColor = "red";

                                    box.appendChild(no);
                                    box.appendChild(type);
                                    box.appendChild(date);
                                    box.appendChild(time_release);
                                    box.appendChild(time);
                                    if (!data.trem.eew[i].cancel) {
                                        box.appendChild(loc);
                                        box.appendChild(lat);
                                        box.appendChild(lon);
                                        box.appendChild(depth);
                                        box.appendChild(scale);
                                        box.appendChild(max);
                                        box.appendChild(alert);
                                    }
                                    frag_2.appendChild(box);
                                }

                                eew_table.replaceChildren(frag_2);
                            }
                        })
                })
        }

        function switch_mode(num) {
            if (!num) {
                back.style.display = "";
                mode.style.display = "none";
                trem.style.display = "";
                if (cache.trem.eew.length) eew.style.display = "";
                raw.style.display = "none";
                title.textContent = `${params.id}${(cache.error) ? " (誤報)" : ""}`;
                return
            } else {
                if (!cache.trem.raw) return;
                if (num > cache.trem.raw.length) return;
                if (!cache.trem.raw[num - 1]) return;
                back.style.display = "none";
                mode.style.display = "";
                trem.style.display = "none";
                eew.style.display = "none";
                raw.style.display = "";
                title.textContent = `TREM EEW ${params.id} 第${num}報`;
            }
            const raw_table = document.getElementById("raw-table");

            const frag = new DocumentFragment();

            for (let i = 0, k = Object.keys(cache.trem.raw[num - 1].station), n = k.length, id = k[i]; i < n; i++, id = k[i]) {
                const box = document.createElement("tr");
                const ID = document.createElement("td");
                ID.textContent = id;
                ID.setAttribute("data-text", ID.textContent);

                const composite = document.createElement("td");
                composite.textContent = cache.trem.raw[num - 1].station[id];
                composite.setAttribute("data-text", composite.textContent);

                const z = document.createElement("td");
                z.textContent = cache.trem.raw[num - 1].z[id].toFixed(2);
                z.setAttribute("data-text", z.textContent);

                const date = document.createElement("td");
                date.textContent = timestamp(cache.trem.raw[num - 1].s_time[id], true);
                date.setAttribute("data-text", date.textContent);

                const p = document.createElement("td");
                p.textContent = (cache.trem.raw[num - 1].time[id] == cache.trem.raw[num - 1].s_time[id]) ? "" : timestamp(cache.trem.raw[num - 1].time[id]);
                p.setAttribute("data-text", p.textContent);

                const s = document.createElement("td");
                s.textContent = timestamp(cache.trem.raw[num - 1].s_time[id]);
                s.setAttribute("data-text", s.textContent);

                box.appendChild(ID);
                box.appendChild(composite);
                box.appendChild(z);
                box.appendChild(date);
                box.appendChild(p);
                box.appendChild(s);
                frag.appendChild(box);
            }

            raw_table.replaceChildren(frag);
        }

        function intensity_int_to_string(int) {
            return (int == 0 || int == 1 || int == 2 || int == 3 || int == 4) ? `${int} 級` : (int == 5) ? "5 弱" : (int == 6) ? "5 強" : (int == 7) ? "6 弱" : (int == 8) ? "6 強" : "7 級";
        }

        function convertDate(date) {
            if (!date.includes(".")) {
                const list = date.split(":");
                date = `${list[0]}:${list[1]}:${list[2]}.${list[3]}`;
            }
            const arr = date.split(/[- :]/);
            return new Date(arr[0], arr[1] - 1, arr[2], arr[3], arr[4], arr[5].split(".")[0], arr[5].split(".")[1]).getTime();
        }

        function pow(int) {
            return Math.pow(int, 2)
        }
    </script>
</body>

</html>